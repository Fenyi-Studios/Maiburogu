<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Maiburogu - 前后端分离博客</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
		<style>
			body {
				background-color: #f9fafb;
			}
			.post-card:hover {
				transform: translateY(-2px);
				transition: all 0.2s;
			}
			[v-cloak] {
				display: none;
			} /* 防止 Vue 等框架闪烁，这里原生实现 */
		</style>
	</head>
	<body class="text-gray-900">
		<!-- 导航栏 -->
		<nav class="bg-white shadow-sm sticky top-0 z-50">
			<div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
				<a href="index.html" class="text-2xl font-bold text-indigo-600">Maiburogu</a>

				<div class="relative w-1/3 hidden md:block">
					<input type="text" id="searchInput" placeholder="搜索文章标题..." class="w-full bg-gray-100 border-none rounded-full py-2 px-4 focus:ring-2 focus:ring-indigo-400 outline-none" />
					<button onclick="handleSearch()" class="absolute right-3 top-2.5 text-gray-400">
						<i class="fa-solid fa-magnifying-glass"></i>
					</button>
				</div>

				<div class="flex items-center space-x-4 text-gray-600">
					<a href="#" class="hover:text-indigo-600">关于</a>
				</div>
			</div>
		</nav>

		<main class="max-w-6xl mx-auto px-4 py-8 flex flex-col md:flex-row gap-8">
			<!-- 左侧文章列表 -->
			<div class="flex-1">
				<!-- 排序切换 -->
				<div class="flex items-center justify-between mb-6">
					<div class="flex space-x-2" id="sortContainer">
						<button onclick="setSort('latest')" data-sort="latest" class="sort-btn px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-medium">最新推荐</button>
						<button onclick="setSort('views')" data-sort="views" class="sort-btn px-4 py-2 rounded-lg bg-white text-gray-600 hover:bg-gray-100 text-sm font-medium">观看最多</button>
						<button onclick="setSort('likes')" data-sort="likes" class="sort-btn px-4 py-2 rounded-lg bg-white text-gray-600 hover:bg-gray-100 text-sm font-medium">最受欢迎</button>
					</div>
				</div>

				<!-- 文章展示区域 -->
				<div id="postsList" class="space-y-4">
					<!-- 由 JavaScript 动态渲染 -->
					<div class="py-20 text-center text-gray-400">正在加载文章...</div>
				</div>
			</div>

			<!-- 右侧边栏 -->
			<aside class="w-full md:w-72 space-y-8">
				<!-- 分类列表 -->
				<div class="bg-white p-6 rounded-xl shadow-sm">
					<h3 class="font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-list-ul mr-2 text-indigo-500"></i> 分类列表</h3>
					<div id="categoryList" class="space-y-2">
						<button onclick="setCategory(null)" class="cat-btn w-full text-left py-2 px-3 rounded-lg bg-indigo-50 text-indigo-600 font-bold">全部文章</button>
						<!-- 由 JavaScript 动态渲染 -->
					</div>
				</div>
			</aside>
		</main>

		<script>
			// 状态管理
			let currentState = {
				search: "",
				sort: "latest",
				category: null,
			};

			// 初始化
			window.onload = () => {
				fetchCategories();
				fetchPosts();

				// 搜索框回车事件
				document.getElementById("searchInput").addEventListener("keypress", (e) => {
					if (e.key === "Enter") handleSearch();
				});
			};

			async function fetchCategories() {
				const res = await fetch("/system/user/index.php?action=get_categories");
				const result = await res.json();
				if (result.success) {
					const container = document.getElementById("categoryList");
					result.data.forEach((cat) => {
						const btn = document.createElement("button");
						btn.className = "cat-btn w-full text-left py-2 px-3 rounded-lg hover:bg-gray-50 text-gray-600 transition";
						btn.innerText = cat.name;
						btn.onclick = () => setCategory(cat.id, btn);
						container.appendChild(btn);
					});
				}
			}

			async function fetchPosts() {
				const listContainer = document.getElementById("postsList");
				listContainer.innerHTML = '<div class="py-20 text-center text-gray-400">正在加载文章...</div>';

				const url = `/system/user/index.php?action=get_posts&search=${encodeURIComponent(currentState.search)}&sort=${currentState.sort}&category=${currentState.category || ""}`;

				try {
					const res = await fetch(url);
					const result = await res.json();

					if (result.success && result.data.length > 0) {
						listContainer.innerHTML = result.data
							.map(
								(post) => `
                        <article class="post-card bg-white p-6 rounded-xl shadow-sm border border-gray-100 transition">
                            <div class="flex items-center space-x-2 text-xs text-indigo-500 font-bold mb-2">
                                <span class="bg-indigo-50 px-2 py-1 rounded uppercase">${post.category_name || "未分类"}</span>
                            </div>
                            <h2 class="text-xl font-bold mb-2 hover:text-indigo-600 cursor-pointer">
                                <a href="post.html?id=${post.id}">${post.title}</a>
                            </h2>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-2">${post.summary || "作者很懒，没有写摘要..."}</p>
                            <div class="flex items-center text-gray-400 text-xs space-x-4">
                                <span><i class="fa-regular fa-clock mr-1"></i> ${post.published_at.split(" ")[0]}</span>
                                <span><i class="fa-regular fa-eye mr-1"></i> ${post.view_count} 观看</span>
                                <span><i class="fa-regular fa-heart mr-1"></i> ${post.like_count} 喜欢</span>
                            </div>
                        </article>
                    `,
							)
							.join("");
					} else {
						listContainer.innerHTML = '<div class="bg-white p-12 text-center rounded-xl shadow-sm text-gray-500">没有找到相关文章。</div>';
					}
				} catch (error) {
					listContainer.innerHTML = '<div class="text-red-500 text-center">数据加载失败，请检查 API 设置。</div>';
				}
			}

			// 交互逻辑
			function setSort(type) {
				currentState.sort = type;
				document.querySelectorAll(".sort-btn").forEach((btn) => {
					if (btn.dataset.sort === type) {
						btn.classList.add("bg-indigo-600", "text-white");
						btn.classList.remove("bg-white", "text-gray-600");
					} else {
						btn.classList.remove("bg-indigo-600", "text-white");
						btn.classList.add("bg-white", "text-gray-600");
					}
				});
				fetchPosts();
			}

			function setCategory(id, el) {
				currentState.category = id;
				document.querySelectorAll(".cat-btn").forEach((btn) => {
					btn.classList.remove("bg-indigo-50", "text-indigo-600", "font-bold");
					btn.classList.add("text-gray-600");
				});
				if (el) {
					el.classList.add("bg-indigo-50", "text-indigo-600", "font-bold");
				} else {
					document.querySelector(".cat-btn").classList.add("bg-indigo-50", "text-indigo-600", "font-bold");
				}
				fetchPosts();
			}

			function handleSearch() {
				currentState.search = document.getElementById("searchInput").value;
				fetchPosts();
			}
		</script>
	</body>
</html>
