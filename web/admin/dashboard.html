<!doctype html>
<html lang="zh-Hant">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>博客管理后台</title>
		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>
		<!-- EasyMDE Markdown Editor CSS -->
		<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css" />
		<!-- Font Awesome for Icons -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

		<style>
			.spinner {
				border: 4px solid rgba(0, 0, 0, 0.1);
				width: 36px;
				height: 36px;
				border-radius: 50%;
				border-left-color: #4f46e5;
				animation: spin 1s linear infinite;
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			.sidebar-transition {
				transition: transform 0.3s ease-in-out;
			}
		</style>
	</head>
	<body class="bg-gray-100 font-sans">
		<!-- 顶部导航 -->
		<nav class="bg-white shadow-sm fixed w-full z-20 top-0">
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
				<div class="flex justify-between h-16">
					<div class="flex items-center">
						<button onclick="toggleSidebar()" class="md:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 mr-2">
							<i class="fas fa-bars text-xl"></i>
						</button>
						<span class="text-xl font-bold text-indigo-600">Maiburogu Admin Dashboard</span>
					</div>
					<div class="flex items-center">
						<span id="adminName" class="text-gray-600 mr-4 hidden sm:inline">管理员</span>
						<button onclick="logout()" class="text-sm text-red-600 hover:text-red-800">登出</button>
					</div>
				</div>
			</div>
		</nav>

		<div class="flex pt-16 min-h-screen relative">
			<!-- 侧边栏 -->
			<div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-20 hidden md:hidden"></div>

			<aside id="sidebar" class="w-64 bg-white shadow-md fixed h-full z-30 transform -translate-x-full md:translate-x-0 md:relative sidebar-transition">
				<div class="p-4">
					<ul class="space-y-2">
						<li>
							<button onclick="switchTab('overview')" class="w-full text-left px-4 py-2 rounded hover:bg-indigo-50 text-gray-700 font-medium tab-btn" data-tab="overview"><i class="fas fa-tachometer-alt mr-2"></i> 仪表盘概览</button>
						</li>
						<li>
							<button onclick="switchTab('posts')" class="w-full text-left px-4 py-2 rounded hover:bg-indigo-50 text-gray-700 font-medium tab-btn" data-tab="posts"><i class="fas fa-file-alt mr-2"></i> 文章管理</button>
						</li>
						<li>
							<button onclick="switchTab('categories')" class="w-full text-left px-4 py-2 rounded hover:bg-indigo-50 text-gray-700 font-medium tab-btn" data-tab="categories"><i class="fas fa-folder mr-2"></i> 分类管理</button>
						</li>
						<li>
							<button onclick="switchTab('comments')" class="w-full text-left px-4 py-2 rounded hover:bg-indigo-50 text-gray-700 font-medium tab-btn" data-tab="comments"><i class="fas fa-comments mr-2"></i> 评论审核</button>
						</li>
						<li>
							<button onclick="switchTab('admins')" class="w-full text-left px-4 py-2 rounded hover:bg-indigo-50 text-gray-700 font-medium tab-btn" data-tab="admins"><i class="fas fa-user-shield mr-2"></i> 管理员管理</button>
						</li>
						<li>
							<button onclick="switchTab('settings')" class="w-full text-left px-4 py-2 rounded hover:bg-indigo-50 text-gray-700 font-medium tab-btn" data-tab="settings"><i class="fas fa-cog mr-2"></i> 系统设置</button>
						</li>
					</ul>
				</div>
			</aside>

			<!-- 主内容区域 -->
			<main class="flex-1 w-full p-4 md:p-8 overflow-x-hidden">
				<!-- 1. 概览视图 -->
				<div id="view-overview" class="view-section">
					<h2 class="text-2xl font-bold mb-6 text-gray-800">数据概览</h2>
					<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
						<div class="bg-white p-6 rounded-lg shadow border-l-4 border-indigo-500">
							<p class="text-gray-500">文章总数</p>
							<p class="text-3xl font-bold text-gray-800" id="stat-posts">-</p>
						</div>
						<div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
							<p class="text-gray-500">分类总数</p>
							<p class="text-3xl font-bold text-gray-800" id="stat-cats">-</p>
						</div>
						<div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
							<p class="text-gray-500">总点赞数</p>
							<p class="text-3xl font-bold text-gray-800" id="stat-likes">-</p>
						</div>
						<div class="bg-white p-6 rounded-lg shadow border-l-4 border-yellow-500">
							<p class="text-gray-500">待审核评论</p>
							<p class="text-3xl font-bold text-gray-800" id="stat-comments">-</p>
						</div>
					</div>
				</div>

				<!-- 2. 文章管理视图 -->
				<div id="view-posts" class="view-section hidden">
					<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
						<h2 class="text-2xl font-bold text-gray-800">文章列表</h2>
						<button onclick="openPostEditor()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 w-full md:w-auto"><i class="fas fa-plus mr-2"></i>写新文章</button>
					</div>
					<div class="bg-white shadow rounded-lg overflow-x-auto">
						<table class="min-w-full divide-y divide-gray-200">
							<thead class="bg-gray-50">
								<tr>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">标题 / 标签</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
									<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
								</tr>
							</thead>
							<tbody class="bg-white divide-y divide-gray-200" id="posts-table-body">
								<!-- JS 填充 -->
							</tbody>
						</table>
					</div>
				</div>

				<!-- 3. 分类管理视图 -->
				<div id="view-categories" class="view-section hidden">
					<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
						<h2 class="text-2xl font-bold text-gray-800">分类管理</h2>
						<button onclick="openCategoryModal()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>新增分类</button>
					</div>
					<div class="bg-white shadow rounded-lg p-4">
						<ul id="categories-list" class="divide-y divide-gray-200">
							<!-- JS 填充 -->
						</ul>
					</div>
				</div>

				<!-- 4. 评论管理视图 -->
				<div id="view-comments" class="view-section hidden">
					<h2 class="text-2xl font-bold mb-6 text-gray-800">最新评论</h2>
					<div class="bg-white shadow rounded-lg overflow-x-auto">
						<table class="min-w-full divide-y divide-gray-200">
							<thead class="bg-gray-50">
								<tr>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">评论者</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">内容</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
									<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
								</tr>
							</thead>
							<tbody class="bg-white divide-y divide-gray-200" id="comments-table-body"></tbody>
						</table>
					</div>
				</div>

				<!-- 5. 系统设置视图 -->
				<div id="view-settings" class="view-section hidden">
					<h2 class="text-2xl font-bold mb-6 text-gray-800">系统设置</h2>
					<div class="bg-white shadow rounded-lg p-6 max-w-3xl">
						<form
							id="settings-form"
							onsubmit="
								event.preventDefault();
								saveSettings();
							">
							<div class="mb-6">
								<h3 class="text-lg font-medium text-gray-900 mb-2">AI 翻译配置 (OpenRouter)</h3>
								<div class="grid grid-cols-1 gap-6">
									<div>
										<label class="block text-sm font-medium text-gray-700">OpenRouter API Key</label>
										<input type="password" id="setting-api-key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" placeholder="sk-or-..." />
									</div>
									<div>
										<label class="block text-sm font-medium text-gray-700">AI 模型</label>
										<input type="text" id="setting-model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 border p-2" placeholder="google/gemini-2.0-flash-001" />
										<p class="text-xs text-gray-500 mt-1">推荐: google/gemini-2.0-flash-001 或 openai/gpt-4o-mini</p>
									</div>
									<div>
										<label class="block text-sm font-medium text-gray-700">目标翻译语言 (多选)</label>
										<div class="mt-2 space-y-2">
											<label class="inline-flex items-center mr-4"> <input type="checkbox" name="target_langs" value="en-US" class="rounded text-indigo-600 focus:ring-indigo-500" /> <span class="ml-2">英语 (en-US)</span> </label>
											<label class="inline-flex items-center mr-4"> <input type="checkbox" name="target_langs" value="ja-JP" class="rounded text-indigo-600 focus:ring-indigo-500" /> <span class="ml-2">日语 (ja-JP)</span> </label>
											<label class="inline-flex items-center mr-4"> <input type="checkbox" name="target_langs" value="zh-CN" class="rounded text-indigo-600 focus:ring-indigo-500" /> <span class="ml-2">简体中文 (zh-CN)</span> </label>
											<label class="inline-flex items-center mr-4"> <input type="checkbox" name="target_langs" value="ko-KR" class="rounded text-indigo-600 focus:ring-indigo-500" /> <span class="ml-2">韩语 (ko-KR)</span> </label>
										</div>
									</div>
								</div>
							</div>
							<div class="flex justify-end">
								<button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">保存设置</button>
							</div>
						</form>
					</div>
				</div>
				<!-- 6. 管理员管理 -->
				<div id="view-admins" class="view-section hidden">
					<div class="flex items-center justify-between mb-6">
						<h2 class="text-2xl font-bold text-gray-800">管理员管理</h2>
						<div class="flex gap-2">
							<button onclick="openAddAdminModal()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm"><i class="fas fa-user-plus mr-1"></i> 添加管理员</button>
							<button onclick="openChangePasswordModal(currentAdminId)" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-900 text-sm"><i class="fas fa-key mr-1"></i> 修改我的密码</button>
						</div>
					</div>

					<div class="bg-white rounded-lg shadow overflow-x-auto">
						<table class="min-w-full">
							<thead class="bg-gray-50">
								<tr>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户名</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">昵称</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最后登录</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
									<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
								</tr>
							</thead>
							<tbody id="adminsTableBody" class="bg-white divide-y divide-gray-200">
								<tr>
									<td class="px-6 py-4 text-sm text-gray-500" colspan="6">加载中...</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</main>
		</div>

		<!-- 编辑文章 Modal -->
		<div id="post-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
			<div class="relative w-full h-full md:h-auto md:w-11/12 md:max-w-6xl mx-auto md:my-10 bg-white shadow-2xl rounded-lg flex flex-col">
				<div class="flex justify-between items-center px-6 py-4 border-b">
					<h3 class="text-xl font-bold text-gray-800" id="modal-title">编辑文章</h3>
					<div>
						<!-- 翻译按钮 -->
						<button id="btn-translate" onclick="translatePost()" class="hidden mr-3 px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm"><i class="fas fa-language mr-1"></i> AI 翻译</button>
						<button onclick="closePostModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
					</div>
				</div>

				<div class="flex-1 overflow-y-auto p-6">
					<form id="post-form">
						<input type="hidden" id="post-id" />

						<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
							<div class="md:col-span-2">
								<label class="block text-gray-700 text-sm font-bold mb-2">文章标题</label>
								<input type="text" id="post-title" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring focus:ring-indigo-200" required />
							</div>
							<div class="md:col-span-1">
								<label class="block text-gray-700 text-sm font-bold mb-2">分类</label>
								<select id="post-category" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring focus:ring-indigo-200">
									<!-- JS填充 -->
								</select>
							</div>
							<div class="md:col-span-1">
								<label class="block text-gray-700 text-sm font-bold mb-2">标签 (逗号分隔)</label>
								<input type="text" id="post-tags" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring focus:ring-indigo-200" placeholder="Java, Linux, 笔记" />
							</div>
							<div class="md:col-span-4">
								<label class="block text-gray-700 text-sm font-bold mb-2">摘要</label>
								<input type="text" id="post-summary" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring focus:ring-indigo-200" />
							</div>
						</div>

						<!-- 翻译状态展示 -->
						<div id="translation-status" class="mb-4 hidden">
							<span class="text-sm font-bold text-gray-600 mr-2">已翻译版本:</span>
							<div id="translation-badges" class="inline-flex gap-2"></div>
						</div>

						<div class="mb-4 p-4 bg-gray-50 rounded border border-gray-200">
							<span class="text-sm font-bold text-gray-600 mr-4">插入媒体:</span>
							<div class="inline-flex gap-2">
								<button type="button" onclick="triggerUpload('image')" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-100"><i class="fas fa-image text-green-500"></i> 图片</button>
								<button type="button" onclick="triggerUpload('video')" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-100"><i class="fas fa-video text-blue-500"></i> 视频</button>
								<button type="button" onclick="triggerUpload('attachment')" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-100"><i class="fas fa-paperclip text-gray-500"></i> 附件</button>
							</div>
							<input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)" />
							<span id="upload-status" class="ml-3 text-sm text-gray-500"></span>
						</div>

						<div class="mb-4">
							<textarea id="markdown-editor"></textarea>
						</div>
					</form>
				</div>

				<div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3 rounded-b-lg">
					<button type="button" onclick="closePostModal()" class="px-4 py-2 bg-white border border-gray-300 rounded text-sm font-medium text-gray-700 hover:bg-gray-50">取消</button>
					<button type="button" onclick="savePost(0)" class="px-4 py-2 bg-yellow-500 text-white rounded shadow-sm text-sm font-medium hover:bg-yellow-600">保存草稿</button>
					<button type="button" onclick="savePost(1)" class="px-4 py-2 bg-indigo-600 text-white rounded shadow-sm text-sm font-medium hover:bg-indigo-700">直接发布</button>
				</div>
			</div>
		</div>

		<!-- 分类编辑 Modal -->
		<div id="category-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
			<div class="bg-white rounded-lg shadow-xl w-96 p-6">
				<h3 class="text-lg font-bold mb-4" id="cat-modal-title">新增分类</h3>
				<input type="hidden" id="cat-id" />
				<div class="mb-4">
					<label class="block text-gray-700 text-sm font-bold mb-2">分类名称</label>
					<input type="text" id="cat-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring focus:ring-indigo-200" />
				</div>
				<div class="flex justify-end gap-2">
					<button onclick="document.getElementById('category-modal').classList.add('hidden')" class="px-4 py-2 border rounded hover:bg-gray-50">取消</button>
					<button onclick="saveCategory()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">保存</button>
				</div>
			</div>
		</div>

		<!-- 删除分类合并 Modal -->
		<div id="cat-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
			<div class="bg-white rounded-lg shadow-xl w-96 p-6">
				<h3 class="text-lg font-bold mb-4 text-red-600">删除分类</h3>
				<p class="mb-4 text-sm text-gray-600">该分类下包含文章，请选择将其移动到：</p>
				<input type="hidden" id="delete-cat-id" />
				<div class="mb-4">
					<select id="merge-to-cat" class="shadow border rounded w-full py-2 px-3 text-gray-700"></select>
				</div>
				<div class="flex justify-end gap-2">
					<button onclick="document.getElementById('cat-delete-modal').classList.add('hidden')" class="px-4 py-2 border rounded hover:bg-gray-50">取消</button>
					<button onclick="confirmDeleteCategory()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">确认删除并合并</button>
				</div>
			</div>
		</div>

		<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
		<script>
			let easyMDE = null;
			let currentUploadType = "";
			let allCategories = [];
			let currentAdminId = null;

			document.addEventListener("DOMContentLoaded", () => {
				checkLogin();
				easyMDE = new EasyMDE({
					element: document.getElementById("markdown-editor"),
					spellChecker: false,
					autosave: { enabled: false },
					maxHeight: "400px",
				});
			});

			// --- UI ---
			function toggleSidebar() {
				const sb = document.getElementById("sidebar");
				const ov = document.getElementById("sidebar-overlay");
				sb.classList.toggle("-translate-x-full");
				ov.classList.toggle("hidden");
			}

			function switchTab(tabName) {
				document.querySelectorAll(".view-section").forEach((el) => el.classList.add("hidden"));
				document.getElementById(`view-${tabName}`).classList.remove("hidden");
				document.querySelectorAll(".tab-btn").forEach((btn) => {
					btn.classList.toggle("bg-indigo-50", btn.dataset.tab === tabName);
					btn.classList.toggle("text-indigo-700", btn.dataset.tab === tabName);
				});

				if (tabName === "overview") loadStats();
				if (tabName === "posts") loadPosts();
				if (tabName === "categories") loadCategories();
				if (tabName === "comments") loadComments();
				if (tabName === "settings") loadSettings();
				if (tabName === "admins") loadAdmins();
			}

			// --- API ---
			async function fetchAPI(action, method = "GET", data = null) {
				const url = `/system/admin/dashboard.php?action=${action}`;
				const options = { method };
				if (data && !(data instanceof FormData)) {
					options.body = JSON.stringify(data);
					options.headers = { "Content-Type": "application/json" };
				} else if (data instanceof FormData) {
					options.body = data;
				}
				const res = await fetch(url, options);
				if (res.status === 401) return (window.location.href = "index.html");
				return await res.json();
			}

			async function checkLogin() {
				const res = await fetchAPI("check_login");
				if (!res.success) window.location.href = "index.html";
				else {
					document.getElementById("adminName").innerText = res.user;

					currentAdminId = res.admin_id ?? null;
					switchTab("overview");
				}
			}

			// --- 分类管理 ---
			async function loadCategories() {
				const res = await fetchAPI("get_categories");
				if (res.success) {
					allCategories = res.data; // 缓存
					const list = document.getElementById("categories-list");
					list.innerHTML = "";
					res.data.forEach((c) => {
						list.innerHTML += `
                        <li class="py-4 flex justify-between items-center">
                            <div>
                                <span class="text-gray-800 font-medium">${c.name}</span>
                                <span class="ml-2 px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-500">${c.post_count} 篇文章</span>
                            </div>
                            <div>
                                <button onclick="editCategory(${c.id}, '${c.name}')" class="text-indigo-600 hover:text-indigo-900 mr-3 text-sm">编辑</button>
                                <button onclick="prepareDeleteCategory(${c.id}, ${c.post_count})" class="text-red-600 hover:text-red-900 text-sm">删除</button>
                            </div>
                        </li>`;
					});
					// 更新统计
					if (document.getElementById("stat-cats")) document.getElementById("stat-cats").innerText = res.data.length;
				}
			}

			function openCategoryModal() {
				document.getElementById("cat-id").value = "";
				document.getElementById("cat-name").value = "";
				document.getElementById("cat-modal-title").innerText = "新增分类";
				document.getElementById("category-modal").classList.remove("hidden");
			}

			function editCategory(id, name) {
				document.getElementById("cat-id").value = id;
				document.getElementById("cat-name").value = name;
				document.getElementById("cat-modal-title").innerText = "编辑分类";
				document.getElementById("category-modal").classList.remove("hidden");
			}

			async function saveCategory() {
				const id = document.getElementById("cat-id").value;
				const name = document.getElementById("cat-name").value;
				const res = await fetchAPI("save_category", "POST", { id, name });
				if (res.success) {
					document.getElementById("category-modal").classList.add("hidden");
					loadCategories();
				} else alert(res.message);
			}

			function prepareDeleteCategory(id, count) {
				if (count > 0) {
					// 需要合并
					const select = document.getElementById("merge-to-cat");
					select.innerHTML = "";
					allCategories.forEach((c) => {
						if (c.id != id) select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
					});
					if (select.children.length === 0) return alert("只剩一个分类，无法删除");

					document.getElementById("delete-cat-id").value = id;
					document.getElementById("cat-delete-modal").classList.remove("hidden");
				} else {
					if (confirm("确定删除空分类？")) executeDeleteCategory(id, id); // merge_to 自身无所谓
				}
			}

			async function confirmDeleteCategory() {
				const id = document.getElementById("delete-cat-id").value;
				const mergeTo = document.getElementById("merge-to-cat").value;
				executeDeleteCategory(id, mergeTo);
			}

			async function executeDeleteCategory(id, mergeToId) {
				const res = await fetchAPI("delete_category", "POST", { id, merge_to_id: mergeToId });
				if (res.success) {
					document.getElementById("cat-delete-modal").classList.add("hidden");
					loadCategories();
				} else alert(res.message);
			}

			// --- 文章管理 ---
			async function loadPosts() {
				const res = await fetchAPI("get_posts");
				const tbody = document.getElementById("posts-table-body");
				tbody.innerHTML = "";
				if (res.success) {
					res.data.forEach((p) => {
						const statusBadge = p.status == 1 ? '<span class="bg-green-100 text-green-800 px-2 rounded-full text-xs">已发布</span>' : '<span class="bg-yellow-100 text-yellow-800 px-2 rounded-full text-xs">草稿</span>';
						let tagsHtml = "";
						if (p.tags)
							p.tags.split(",").forEach((t) => {
								if (t) tagsHtml += `<span class="bg-gray-100 text-gray-500 text-xs px-1 rounded mr-1">#${t}</span>`;
							});

						tbody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4">
                                <div class="font-medium text-gray-900">${p.title}</div>
                                <div class="mt-1">${tagsHtml}</div>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500">${p.category_name || "默认"}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-right text-sm">
                                <button onclick="openPostEditor(${p.id})" class="text-indigo-600 hover:text-indigo-900 mr-2">编辑</button>
                                <button onclick="deletePost(${p.id})" class="text-red-600 hover:text-red-900">删除</button>
                            </td>
                        </tr>`;
					});
				}
			}

			async function openPostEditor(id = null) {
				// 1. 加载分类下拉框
				if (allCategories.length === 0) await loadCategories();
				const catSelect = document.getElementById("post-category");
				catSelect.innerHTML = "";
				allCategories.forEach((c) => {
					catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
				});

				// 2. 重置表单
				document.getElementById("post-form").reset();
				document.getElementById("post-id").value = "";
				document.getElementById("modal-title").innerText = id ? "编辑文章" : "写新文章";
				document.getElementById("btn-translate").classList.add("hidden");
				document.getElementById("translation-status").classList.add("hidden");
				easyMDE.value("");

				if (id) {
					const res = await fetchAPI("get_post_detail&id=" + id);
					if (res.success) {
						const p = res.data;
						document.getElementById("post-id").value = p.id;
						document.getElementById("post-title").value = p.title;
						document.getElementById("post-category").value = p.category_id || 1;
						document.getElementById("post-tags").value = p.tags || "";
						document.getElementById("post-summary").value = p.summary || "";
						easyMDE.value(p.content);

						// 显示翻译按钮
						document.getElementById("btn-translate").classList.remove("hidden");

						// 显示已翻译版本
						if (p.translations && p.translations.length > 0) {
							const badgeContainer = document.getElementById("translation-badges");
							badgeContainer.innerHTML = "";
							p.translations.forEach((t) => {
								badgeContainer.innerHTML += `<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded border border-green-200" title="${t.title}">${t.lang}</span>`;
							});
							document.getElementById("translation-status").classList.remove("hidden");
						}
					}
				}
				setTimeout(() => easyMDE.codemirror.refresh(), 100);
				document.getElementById("post-modal").classList.remove("hidden");
			}

			function closePostModal() {
				document.getElementById("post-modal").classList.add("hidden");
			}

			async function savePost(status) {
				const title = document.getElementById("post-title").value;
				if (!title) return alert("请输入标题");

				const data = {
					id: document.getElementById("post-id").value || null,
					title: title,
					category_id: document.getElementById("post-category").value,
					tags: document.getElementById("post-tags").value,
					summary: document.getElementById("post-summary").value,
					content: easyMDE.value(),
					status: status,
				};

				const res = await fetchAPI("save_post", "POST", data);
				if (res.success) {
					alert("保存成功");
					closePostModal();
					loadPosts();
				} else alert("失败: " + res.message);
			}

			// --- 翻译功能 ---
			async function translatePost() {
				const id = document.getElementById("post-id").value;
				if (!id) return alert("请先保存文章再进行翻译");
				if (!confirm("确定开始 AI 翻译？这可能需要几秒钟时间。")) return;

				const btn = document.getElementById("btn-translate");
				const originalText = btn.innerHTML;
				btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 翻译中...';
				btn.disabled = true;

				const res = await fetchAPI("ai_translate", "POST", { post_id: id });
				btn.innerHTML = originalText;
				btn.disabled = false;

				if (res.success) {
					alert("翻译完成！");
					openPostEditor(id); // 重新加载以显示新的翻译标签
				} else {
					alert("翻译失败: " + res.message);
				}
			}

			// --- 系统设置 ---
			async function loadSettings() {
				const res = await fetchAPI("get_settings");
				if (res.success) {
					const s = res.data;
					document.getElementById("setting-api-key").value = s.openrouter_api_key;
					document.getElementById("setting-model").value = s.ai_model;
					// Checkboxes
					document.querySelectorAll('input[name="target_langs"]').forEach((cb) => {
						cb.checked = s.target_langs.includes(cb.value);
					});
				}
			}

			async function saveSettings() {
				const langs = [];
				document.querySelectorAll('input[name="target_langs"]:checked').forEach((cb) => langs.push(cb.value));

				const data = {
					openrouter_api_key: document.getElementById("setting-api-key").value,
					ai_model: document.getElementById("setting-model").value,
					target_langs: langs,
				};

				const res = await fetchAPI("save_settings", "POST", data);
				if (res.success) alert("设置已保存");
				else alert("保存失败");
			}

			// --- 基础数据统计 ---
			async function loadStats() {
				const res = await fetchAPI("get_stats");
				if (res.success) {
					document.getElementById("stat-posts").innerText = res.data.posts;
					document.getElementById("stat-cats").innerText = res.data.categories;
					document.getElementById("stat-likes").innerText = res.data.likes;
					document.getElementById("stat-comments").innerText = res.data.pending_comments;
				}
			}

			// --- 其他辅助 (上传/删除/评论) 保持之前的逻辑 ---
			async function deletePost(id) {
				if (confirm("删除文章？")) {
					await fetchAPI("delete_post", "POST", { id });
					loadPosts();
				}
			}
			async function loadComments() {
				/* 同之前 */
				const res = await fetchAPI("get_comments");
				const tbody = document.getElementById("comments-table-body");
				tbody.innerHTML = "";
				if (res.success) {
					res.data.forEach((c) => {
						const statusHtml = c.is_audited == 1 ? '<span class="text-green-600 text-xs">通过</span>' : `<button onclick="auditComment(${c.id})" class="text-indigo-600 text-xs">通过</button>`;
						tbody.innerHTML += `<tr><td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${c.nickname}</div></td><td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${c.content}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${statusHtml}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onclick="deleteComment(${c.id})" class="text-red-600 hover:text-red-900 text-xs">删除</button></td></tr>`;
					});
				}
			}
			async function auditComment(id) {
				if ((await fetchAPI("audit_comment", "POST", { id })).success) loadComments();
			}
			async function deleteComment(id) {
				if ((await fetchAPI("delete_comment", "POST", { id })).success) loadComments();
			}
			async function logout() {
				await fetchAPI("logout");
				window.location.href = "index.html";
			}
			function triggerUpload(type) {
				currentUploadType = type;
				document.getElementById("file-input").click();
			}
			async function handleFileSelect(input) {
				/* 同之前上传逻辑 */
				if (input.files && input.files[0]) {
					const formData = new FormData();
					formData.append("file", input.files[0]);
					formData.append("type", currentUploadType);
					const res = await fetchAPI("upload_file", "POST", formData);
					if (res.success) {
						const cm = easyMDE.codemirror;
						let md = currentUploadType === "image" ? `![${res.filename}](${res.url})` : `[${res.filename}](${res.url})`;
						cm.replaceSelection(md);
					} else alert(res.message);
				}
			}

			// --- 管理员管理 ---
			async function loadAdmins() {
				const res = await fetchAPI("get_admins");
				if (!res.success) return alert(res.message || "加载失败");
				const tbody = document.getElementById("adminsTableBody");
				if (!tbody) return;
				const admins = res.admins || [];
				if (admins.length === 0) {
					tbody.innerHTML = `<tr><td class="px-6 py-4 text-sm text-gray-500" colspan="6">暂无管理员</td></tr>`;
					return;
				}
				tbody.innerHTML = admins
					.map((a) => {
						const isMe = currentAdminId && Number(a.id) === Number(currentAdminId);
						const lastLogin = a.last_login_at ? a.last_login_at : "-";
						const createdAt = a.created_at ? a.created_at : "-";
						const nick = a.nickname ? a.nickname : "-";
						return `
						<tr>
							<td class="px-6 py-4 text-sm text-gray-700">${a.id}</td>
							<td class="px-6 py-4 text-sm text-gray-700">
								${escapeHtml(a.username)} ${isMe ? '<span class="ml-2 text-xs px-2 py-0.5 rounded bg-indigo-50 text-indigo-700">当前</span>' : ""}
							</td>
							<td class="px-6 py-4 text-sm text-gray-700">${escapeHtml(nick)}</td>
							<td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(lastLogin)}</td>
							<td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(createdAt)}</td>
							<td class="px-6 py-4 text-sm text-right space-x-2">
								<button class="text-xs px-3 py-1 rounded bg-gray-800 text-white hover:bg-gray-900" onclick="openChangePasswordModal(${a.id}, '${escapeAttr(a.username)}')">
									<i class="fas fa-key mr-1"></i>改密
								</button>
								${
									isMe
										? ""
										: `<button class="text-xs px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700" onclick="deleteAdmin(${a.id})">
									<i class="fas fa-trash mr-1"></i>删除
								</button>`
								}
							</td>
						</tr>`;
					})
					.join("");
			}

			function openAddAdminModal() {
				const m = document.getElementById("addAdminModal");
				m.classList.remove("hidden");
				m.classList.add("flex");
				document.getElementById("newAdminUsername").value = "";
				document.getElementById("newAdminNickname").value = "";
				document.getElementById("newAdminPassword").value = "";
			}
			function closeAddAdminModal() {
				const m = document.getElementById("addAdminModal");
				m.classList.add("hidden");
				m.classList.remove("flex");
			}
			async function submitAddAdmin() {
				const username = document.getElementById("newAdminUsername").value.trim();
				const nickname = document.getElementById("newAdminNickname").value.trim();
				const password = document.getElementById("newAdminPassword").value;
				const res = await fetchAPI("add_admin", "POST", { username, nickname, password });
				if (!res.success) return alert(res.message || "添加失败");
				closeAddAdminModal();
				await loadAdmins();
				alert("添加成功");
			}

			function openChangePasswordModal(id, username = "") {
				const m = document.getElementById("changePasswordModal");
				m.classList.remove("hidden");
				m.classList.add("flex");
				document.getElementById("changePwdAdminId").value = id;
				document.getElementById("oldPassword").value = "";
				document.getElementById("newPassword").value = "";
				const isMe = currentAdminId && Number(id) === Number(currentAdminId);
				document.getElementById("oldPwdWrap").classList.toggle("hidden", !isMe);
				document.getElementById("changePwdTitle").innerText = isMe ? "修改我的密码" : `修改密码：${username || "管理员#" + id}`;
			}
			function closeChangePasswordModal() {
				const m = document.getElementById("changePasswordModal");
				m.classList.add("hidden");
				m.classList.remove("flex");
			}
			async function submitChangePassword() {
				const id = Number(document.getElementById("changePwdAdminId").value || 0);
				const old_password = document.getElementById("oldPassword").value;
				const new_password = document.getElementById("newPassword").value;
				const payload = { id, new_password };
				const isMe = currentAdminId && Number(id) === Number(currentAdminId);
				if (isMe) payload.old_password = old_password;
				const res = await fetchAPI("change_password", "POST", payload);
				if (!res.success) return alert(res.message || "修改失败");
				closeChangePasswordModal();
				alert("密码已更新");
			}

			async function deleteAdmin(id) {
				if (!confirm("确定要删除该管理员吗？此操作不可恢复。")) return;
				const res = await fetchAPI("delete_admin", "POST", { id });
				if (!res.success) return alert(res.message || "删除失败");
				await loadAdmins();
				alert("删除成功");
			}

			// --- utils ---
			function escapeHtml(str) {
				if (str === null || str === undefined) return "";
				return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
			}
			function escapeAttr(str) {
				// for single-quoted attr usage
				return escapeHtml(str).replaceAll("&#039;", "\\'");
			}
		</script>

		<!-- 添加管理员 Modal -->
		<div id="addAdminModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
			<div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
				<div class="p-6 border-b flex justify-between items-center">
					<h3 class="text-lg font-bold text-gray-800">添加管理员</h3>
					<button onclick="closeAddAdminModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
				</div>
				<div class="p-6 space-y-4">
					<div>
						<label class="block text-sm text-gray-600 mb-1">用户名</label>
						<input id="newAdminUsername" type="text" class="w-full border rounded px-3 py-2" placeholder="3-64位，仅字母数字._-" />
					</div>
					<div>
						<label class="block text-sm text-gray-600 mb-1">昵称（可选）</label>
						<input id="newAdminNickname" type="text" class="w-full border rounded px-3 py-2" placeholder="例如：运营小王" />
					</div>
					<div>
						<label class="block text-sm text-gray-600 mb-1">初始密码</label>
						<input id="newAdminPassword" type="password" class="w-full border rounded px-3 py-2" placeholder="至少6位" />
					</div>
					<p class="text-xs text-gray-500">提示：首次登录后建议立刻修改密码。</p>
				</div>
				<div class="p-6 border-t flex justify-end gap-2">
					<button onclick="closeAddAdminModal()" class="px-4 py-2 rounded border text-gray-700 hover:bg-gray-50">取消</button>
					<button onclick="submitAddAdmin()" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">添加</button>
				</div>
			</div>
		</div>

		<!-- 修改密码 Modal -->
		<div id="changePasswordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
			<div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
				<div class="p-6 border-b flex justify-between items-center">
					<h3 id="changePwdTitle" class="text-lg font-bold text-gray-800">修改密码</h3>
					<button onclick="closeChangePasswordModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
				</div>
				<div class="p-6 space-y-4">
					<input type="hidden" id="changePwdAdminId" />
					<div id="oldPwdWrap">
						<label class="block text-sm text-gray-600 mb-1">旧密码</label>
						<input id="oldPassword" type="password" class="w-full border rounded px-3 py-2" />
					</div>
					<div>
						<label class="block text-sm text-gray-600 mb-1">新密码</label>
						<input id="newPassword" type="password" class="w-full border rounded px-3 py-2" placeholder="至少6位" />
					</div>
				</div>
				<div class="p-6 border-t flex justify-end gap-2">
					<button onclick="closeChangePasswordModal()" class="px-4 py-2 rounded border text-gray-700 hover:bg-gray-50">取消</button>
					<button onclick="submitChangePassword()" class="px-4 py-2 rounded bg-gray-800 text-white hover:bg-gray-900">保存</button>
				</div>
			</div>
		</div>
	</body>
</html>
